name: Update domain lists for SmartDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare domain-set directory
        run: mkdir -p domain-set

      - name: Download and process domain lists
        run: |
          echo "=== 阶段0: 处理自定义规则 (最高优先级) ==="
          
          # 下载自定义规则文件
          if curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/custom-rules.txt -o custom-rules.txt; then
            echo "自定义规则文件下载成功"
            
            # 解析自定义规则，分类到不同的临时文件
            grep -v "^#" custom-rules.txt | grep -v "^$" | while IFS=',' read -r domain rule; do
              # 去除空格
              domain=$(echo "$domain" | tr -d ' ')
              rule=$(echo "$rule" | tr -d ' ')
              
              case "$rule" in
                direct)
                  echo "$domain" >> custom-direct.txt
                  ;;
                proxy)
                  echo "$domain" >> custom-proxy.txt
                  ;;
                reject)
                  echo "$domain" >> custom-reject.txt
                  ;;
              esac
            done
            
            # 确保文件存在（即使为空）
            touch custom-direct.txt custom-proxy.txt custom-reject.txt
            
            # 去重排序
            sort -u custom-direct.txt -o custom-direct.txt 2>/dev/null || touch custom-direct.txt
            sort -u custom-proxy.txt -o custom-proxy.txt 2>/dev/null || touch custom-proxy.txt
            sort -u custom-reject.txt -o custom-reject.txt 2>/dev/null || touch custom-reject.txt
            
            echo "自定义规则统计："
            echo "  direct: $(wc -l < custom-direct.txt 2>/dev/null || echo 0) 个域名"
            echo "  proxy:  $(wc -l < custom-proxy.txt 2>/dev/null || echo 0) 个域名"
            echo "  reject: $(wc -l < custom-reject.txt 2>/dev/null || echo 0) 个域名"
          else
            echo "警告: 自定义规则文件不存在或下载失败，跳过此步骤"
            touch custom-direct.txt custom-proxy.txt custom-reject.txt
          fi
          
          echo ""
          echo "=== 阶段1: 下载并独立 apple-cn 和 google-cn ==="
          
          # 下载 apple-cn 和 google-cn (独立文件)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/apple-cn.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/apple-cn.txt
          echo "apple-cn.txt 域名数: $(wc -l < domain-set/apple-cn.txt)"
          
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/google-cn.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/google-cn.txt
          echo "google-cn.txt 域名数: $(wc -l < domain-set/google-cn.txt)"
          
          # 创建 apple-cn 和 google-cn 的合并排除列表
          cat domain-set/apple-cn.txt domain-set/google-cn.txt | sort -u > temp-apple-google-exclude.txt
          echo "apple+google 合并域名数: $(wc -l < temp-apple-google-exclude.txt)"
          
          echo ""
          echo "=== 阶段2: 处理 direct-list (排除 apple-cn 和 google-cn) ==="
          
          # 下载并处理 direct-list
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > temp-direct-original.txt
          echo "原始 direct-list 域名数: $(wc -l < temp-direct-original.txt)"
          
          # 从 direct-list 中排除 apple-cn 和 google-cn
          grep -vxFf temp-apple-google-exclude.txt temp-direct-original.txt > temp-direct-step1.txt || true
          echo "排除 apple/google 后 direct-list 域名数: $(wc -l < temp-direct-step1.txt)"
          
          echo ""
          echo "=== 阶段3: 处理 proxy-list (排除 apple-cn 和 google-cn) ==="
          
          # 下载并处理 proxy-list
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > temp-proxy-original.txt
          echo "原始 proxy-list 域名数: $(wc -l < temp-proxy-original.txt)"
          
          # 从 proxy-list 中排除 apple-cn 和 google-cn
          grep -vxFf temp-apple-google-exclude.txt temp-proxy-original.txt > temp-proxy-step1.txt || true
          echo "排除 apple/google 后 proxy-list 域名数: $(wc -l < temp-proxy-step1.txt)"
          
          echo ""
          echo "=== 阶段4: 处理 reject-list (保持原样,最高优先级) ==="
          
          # 下载 reject-list (最高优先级,保持不变)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > temp-reject-original.txt
          echo "原始 reject-list 域名数: $(wc -l < temp-reject-original.txt)"
          
          echo ""
          echo "=== 阶段5: 按优先级去重 (reject > direct > proxy) ==="
          
          # 从 direct-list 中移除所有在 reject-list 中的域名
          grep -vxFf temp-reject-original.txt temp-direct-step1.txt > temp-direct-step2.txt || true
          echo "direct-list 去重后域名数: $(wc -l < temp-direct-step2.txt)"
          
          # 从 proxy-list 中移除所有在 reject-list 中的域名
          grep -vxFf temp-reject-original.txt temp-proxy-step1.txt > temp-proxy-step2.txt || true
          
          # 从 proxy-list 中移除所有在 direct-list 中的域名
          grep -vxFf temp-direct-step2.txt temp-proxy-step2.txt > temp-proxy-step3.txt || true
          echo "proxy-list 去重后域名数: $(wc -l < temp-proxy-step3.txt)"
          
          echo ""
          echo "=== 阶段6: 应用自定义规则 (覆盖所有其他规则) ==="
          
          # 先从所有列表中移除自定义规则中的域名
          if [ -s custom-direct.txt ] || [ -s custom-proxy.txt ] || [ -s custom-reject.txt ]; then
            # 创建自定义域名总列表
            cat custom-direct.txt custom-proxy.txt custom-reject.txt | sort -u > custom-all-domains.txt
            
            # 从各列表中移除这些域名
            grep -vxFf custom-all-domains.txt temp-direct-step2.txt > temp-direct-step3.txt || cp temp-direct-step2.txt temp-direct-step3.txt
            grep -vxFf custom-all-domains.txt temp-proxy-step3.txt > temp-proxy-step4.txt || cp temp-proxy-step3.txt temp-proxy-step4.txt
            grep -vxFf custom-all-domains.txt temp-reject-original.txt > temp-reject-step1.txt || cp temp-reject-original.txt temp-reject-step1.txt
            
            # 添加自定义域名到对应列表
            cat temp-direct-step3.txt custom-direct.txt | sort -u > domain-set/direct-list.txt
            cat temp-proxy-step4.txt custom-proxy.txt | sort -u > domain-set/proxy-list.txt
            cat temp-reject-step1.txt custom-reject.txt | sort -u > domain-set/reject-list.txt
            
            echo "应用自定义规则后："
            echo "  direct-list 最终域名数: $(wc -l < domain-set/direct-list.txt)"
            echo "  proxy-list 最终域名数: $(wc -l < domain-set/proxy-list.txt)"
            echo "  reject-list 最终域名数: $(wc -l < domain-set/reject-list.txt)"
          else
            echo "没有自定义规则，使用原始处理结果"
            cp temp-direct-step2.txt domain-set/direct-list.txt
            cp temp-proxy-step3.txt domain-set/proxy-list.txt
            cp temp-reject-original.txt domain-set/reject-list.txt
          fi
          
          # Process PCDN list
          curl -sSL https://thhbdd.github.io/Block-pcdn-domains/ban.txt > temp-pcdn-1.txt
          curl -sSL https://cdn.jsdelivr.net/gh/susetao/PCDNFilter-CHN-@main/PCDNFilter.txt > temp-pcdn-2.txt
          cat temp-pcdn-*.txt | \
            grep -v '^#' | \
            grep -v '^$' | \
            grep -v '^/' | \
            sed 's/||//g; s/\^//g' | \
            grep '\.' | \
            sort -u > domain-set/pcdn-list.txt
          
          # Process HttpDNS list
          curl -sSL https://raw.githubusercontent.com/yyysuo/firetv/master/httpdns.txt | \
            grep -v '^#' | \
            grep -v '^$' | \
            sed 's/||//g; s/\^//g' | \
            grep '\.' | \
            sort -u > domain-set/httpdns-list.txt
          
          # Clean up
          rm -f temp-*.txt

      - name: Check for duplicate domains across lists
        run: |
          echo ""
          echo "=========================================="
          echo "=== 域名列表重复检查 (应全部为 0) ==="
          echo "=========================================="
          echo ""
          
          # 检查 direct-list 与 apple-cn 的重复
          echo ">>> direct-list.txt 与 apple-cn.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/apple-cn.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/apple-cn.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 direct-list 与 google-cn 的重复
          echo ">>> direct-list.txt 与 google-cn.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/google-cn.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/google-cn.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 direct-list 与 proxy-list 的重复
          echo ">>> direct-list.txt 与 proxy-list.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/proxy-list.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/proxy-list.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 direct-list 与 reject-list 的重复
          echo ">>> direct-list.txt 与 reject-list.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/reject-list.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/direct-list.txt) <(sort domain-set/reject-list.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 proxy-list 与 reject-list 的重复
          echo ">>> proxy-list.txt 与 reject-list.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/reject-list.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/reject-list.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 apple-cn 与 google-cn 的重复
          echo ">>> apple-cn.txt 与 google-cn.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/apple-cn.txt) <(sort domain-set/google-cn.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/apple-cn.txt) <(sort domain-set/google-cn.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 proxy-list 与 apple-cn 的重复
          echo ">>> proxy-list.txt 与 apple-cn.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/apple-cn.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/apple-cn.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 检查 proxy-list 与 google-cn 的重复
          echo ">>> proxy-list.txt 与 google-cn.txt 的重复:"
          DUPLICATE_COUNT=$(comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/google-cn.txt) | wc -l)
          echo "重复数量: $DUPLICATE_COUNT"
          if [ "$DUPLICATE_COUNT" -ne 0 ]; then
            echo "⚠️  警告: 发现重复域名!"
            comm -12 <(sort domain-set/proxy-list.txt) <(sort domain-set/google-cn.txt) | head -10
          else
            echo "✅ 通过"
          fi
          echo ""
          
          # 统计各文件的域名数量
          echo "=========================================="
          echo "=== 各文件域名数量统计 ==="
          echo "=========================================="
          echo "direct-list.txt:  $(wc -l < domain-set/direct-list.txt) 个域名"
          echo "proxy-list.txt:   $(wc -l < domain-set/proxy-list.txt) 个域名"
          echo "reject-list.txt:  $(wc -l < domain-set/reject-list.txt) 个域名"
          echo "apple-cn.txt:     $(wc -l < domain-set/apple-cn.txt) 个域名"
          echo "google-cn.txt:    $(wc -l < domain-set/google-cn.txt) 个域名"
          echo "pcdn-list.txt:    $(wc -l < domain-set/pcdn-list.txt) 个域名"
          echo "httpdns-list.txt: $(wc -l < domain-set/httpdns-list.txt) 个域名"
          echo ""
          
          # 计算总域名数
          TOTAL=$(($(wc -l < domain-set/direct-list.txt) + $(wc -l < domain-set/proxy-list.txt) + $(wc -l < domain-set/reject-list.txt) + $(wc -l < domain-set/apple-cn.txt) + $(wc -l < domain-set/google-cn.txt)))
          echo "前5个文件总域名数: $TOTAL 个 (不含 pcdn 和 httpdns)"
          echo "=========================================="

      - name: Commit and push updated domain lists to repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add domain-set/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update domain lists on $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git push

      - name: Archive domain lists
        run: zip -r smartdns-domain-lists.zip domain-set

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v1
        with:
          tag_name: V-${{ steps.date.outputs.date }}
          name: Released on ${{ steps.date.outputs.date }}
          body: 自动更新域名清单，包含 direct / proxy / reject
          files: smartdns-domain-lists.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old Releases (保留最近 7 个)
        uses: dev-drprasad/delete-older-releases@v0.2.1
        with:
          keep_latest: 7
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
