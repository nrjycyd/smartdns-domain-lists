name: Update domain lists for SmartDNS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare domain-set directory
        run: mkdir -p domain-set

      - name: Download and process domain lists
        run: |
          # Process direct-list
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/direct-list.txt
          
          # Process apple-cn (独立文件)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/apple-cn.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/apple-cn.txt
          
          # Process google-cn (独立文件)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/google-cn.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/google-cn.txt
          
          # Process proxy-list (排除 google-cn 和 apple-cn)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt > temp-proxy.txt
          
          # 创建排除列表
          cat domain-set/apple-cn.txt domain-set/google-cn.txt > temp-exclude.txt
          
          # 从 proxy-list 中移除排除列表中的域名
          cat temp-proxy.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > temp-proxy-clean.txt
          
          grep -vFf temp-exclude.txt temp-proxy-clean.txt > domain-set/proxy-list.txt || true
          
          # Process reject-list
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt | \
            sed '/^regexp:/d; s/full://g' | \
            sort -u > domain-set/reject-list.txt
          
          # Process PCDN list
          curl -sSL https://thhbdd.github.io/Block-pcdn-domains/ban.txt > temp-pcdn-1.txt
          curl -sSL https://cdn.jsdelivr.net/gh/susetao/PCDNFilter-CHN-@main/PCDNFilter.txt > temp-pcdn-2.txt
          cat temp-pcdn-*.txt | \
            grep -v '^#' | \
            grep -v '^$' | \
            grep -v '^/' | \
            sed 's/||//g; s/\^//g' | \
            grep '\.' | \
            sort -u > domain-set/pcdn-list.txt
          
          # Process HttpDNS list
          curl -sSL https://raw.githubusercontent.com/yyysuo/firetv/master/httpdns.txt | \
            grep -v '^#' | \
            grep -v '^$' | \
            sed 's/||//g; s/\^//g' | \
            grep '\.' | \
            sort -u > domain-set/httpdns-list.txt
          
          # Clean up
          rm -f temp-*.txt      

      - name: Commit and push updated domain lists to repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add domain-set/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update domain lists on $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git push

      - name: Archive domain lists
        run: zip -r smartdns-domain-lists.zip domain-set

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v1
        with:
          tag_name: V-${{ steps.date.outputs.date }}
          name: Released on ${{ steps.date.outputs.date }}
          body: 自动更新域名清单，包含 direct / proxy / reject
          files: smartdns-domain-lists.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old Releases (保留最近 7 个)
        uses: dev-drprasad/delete-older-releases@v0.2.1
        with:
          keep_latest: 7
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
